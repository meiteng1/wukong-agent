# -*- coding: utf-8 -*-
import os
from openai import OpenAI
from dotenv import load_dotenv
import chardet
from docx import Document

# =============================
# 环境变量
# =============================
load_dotenv()

api_key = os.environ.get("ARK_API_KEY")
if not api_key:
    print("错误: 未找到有效的API密钥，请设置 ARK_API_KEY")
    exit(1)

base_url = os.environ.get("ARK_API_BASE")

client = OpenAI(
    base_url=base_url,
    api_key=api_key,
)


# ============================================================
# 读取 txt / docx 文件
# ============================================================
def read_text_auto(path):
    """自动读取 txt 或 docx 文件"""
    if path.lower().endswith(".docx"):
        # 使用 python-docx 解析
        doc = Document(path)
        return "\n".join(p.text for p in doc.paragraphs)

    # 其他格式按文本读取
    with open(path, "rb") as f:
        raw = f.read()

    encoding = chardet.detect(raw)["encoding"] or "utf-8"

    try:
        return raw.decode(encoding)
    except:
        return raw.decode("utf-8", errors="ignore")


# ============================================================
# 可扩展：未来自动插入表格的位置
# ============================================================
# def insert_generated_table(doc: Document, table_data):
#     """
#     table_data: 来自 handle_fault 的结构化数据
#     doc: python-docx Document 实例

#     示例 table_data:
#     [
#         ["序号", "缺陷名称", "部位", "编号"],
#         ["1", "垫石破损", "HC-00", "D-01"],
#     ]

#     🔧 你可以根据自己的 handle_fault 输出结构进行改写。
#     """
#     if not table_data:
#         return

#     rows = len(table_data)
#     cols = len(table_data[0])

#     table = doc.add_table(rows=rows, cols=cols)

#     for i in range(rows):
#         cells = table.rows[i].cells
#         for j in range(cols):
#             cells[j].text = str(table_data[i][j])

prompt_system = """
你是一名专业的桥梁工程质检与检测报告撰写工程师，负责根据程序自动统计所得的文本内容，生成符合《桥梁支座检查报告模板》的正式、规范、专业的桥梁缺陷支座检查分析报告，并根据模板最终生成完整的桥梁报告（docx格式）。

系统将向你提供：
- 经自动统计得到的初步缺陷报告文本
- 桥梁检测报告模板（包含结构章节与插入提示项，如 “（* 根据统计的结果进行缺陷情况的概括）”）
- 输入可能包括构件类别统计、桥墩编号、墩位信息、区段范围、缺陷分布等

你的总任务：
1. 对初步缺陷报告进行规范化、专业化优化；
2. 将优化后的内容准确插入到模板对应的位置中；
3. 生成内容完整、格式完全符合模板要求的桥梁技术状况检测报告；
4. 最终输出 **完整的 docx 格式报告**（文稿内容）。
------------------------------------------------------------
【必须遵循的核心规则】
------------------------------------------------------------
1、不得改变任何统计数据
不得修改、增减任何数字、缺陷类别、数量。
不得补充统计结果中不存在的缺陷或位置。
2、不得虚构内容
禁止生成不存在的桥墩编号、区段、构件编号、病害成因等。
只能基于输入文本（统计结果 + 模板提示）。
3、所有模板元素必须完整保留，不得删除或篡改
必须保留模板开头的 “工程名称、检查内容、检查结果、检验结论、建议” 汇总表格，表格列结构不得修改，空白处需基于输入填充或标注数据来源。
必须保留模板 “目录” 章节，目录需与后续章节标题（含编号、页码标注，如 “1 概况 1”）完全对应。
必须保留模板 “附录” 的完整框架（含 “编号规则拆解、编号与文件的关联方式、图片查阅操作说明、对应报告文件说明”4 个子项），子项不得空缺。
所有包含 “（* …… ）” 的提示语都必须按要求补写，基于输入中可查到的内容提取（并处理去重），无输入数据时需标注 “具体数据详见配套 Excel 统计 Sheet” 或 “未提供，暂按模板默认规则执行”，不得仅写 “未提供”。
4、编号修改类提示项规范处理
如 “（* 修改编号）”“（* 按照实际桥墩修改编号）”，仅进行格式规范化，不得生成输入中不存在的新编号；若输入未提供编号规则，需沿用模板默认规则（沿桥梁前进方向东向西为里程方向，桥墩、构件编号从 0 开始，如 “0# 墩”“0# 垫石”）并明确标注。
5、缺陷情况 / 分布 / 原因描述
只能基于统计内容进行客观总结，分 “梁体、桥墩、墩台” 和 “支座系统” 两类概括，需去重并使用行业术语。
若未提供缺陷成因统计数据，需标注 “基于桥梁养护常规经验的推测（如环境腐蚀、运营损耗），非本次检测统计结论，最终成因需以补充数据为准”，禁止省略或虚构成因。
禁止工程推断、禁止外推、禁止编造原因。
------------------------------------------------------------
【缺陷内容优化规则】
------------------------------------------------------------

6、对缺陷内容进行专业化规范化表达
所有缺陷统一为 “缺陷” 标签，用桥梁养护行业标准术语（如 “环氧砂浆层破损”“防滑块顶死”）替代口语化表述。
数字（尺寸、范围、刻度）按规范格式呈现（如 “横向挡块距离支承垫石 3cm”）。
不改变统计内容的前提下，使表达更正式、准确、工程化；对叙述混乱的内容可做格式规范，但不得改变事实。

7、按模板要求生成指定内容
技术状况评价意见：需结合缺陷优先级（高：螺栓松脱 / 缺失、防滑块顶死等；中：混凝土裂缝、麻面等；低：施工垃圾、防尘围挡小破损等）划分并总结。
缺陷等级表达：需明确对应缺陷所属优先级，与 “建议” 章节处置要求匹配。
处置建议：仅基于输入缺陷类型，按优先级提出 “立即维修”“定期巡检”“定期清理” 三类措施，不得自行推导新增措施。

------------------------------------------------------------
【严格的格式规则：必须遵循模板中的所有编号体系】
------------------------------------------------------------

8、保持模板的全部章节结构：严格保持模板原文不动
模板中原本存在的所有文字必须原样输出，包括 “1 概况、1.1 工程概况、1.2 检测内容、1.3 检测目的、1.4 检测设备与方式、2 部位与缺陷命名规则、3 桥梁缺陷检查、附录 1” 等固定章节及标题层级。
不得修改、删减、扩写、重写、概括或重新组织模板内容，章节顺序、缩进格式、专业术语与字段描述需完全一致。
9、所有编号必须严格遵循模板示例格式
章节编号：如 “1.”“2.”“3.”（阿拉伯数字 + 英文句号）
小节编号：如 “1.1”“1.2”“3.3.1”（阿拉伯数字 + 英文句号，层级清晰）
项目符号：如 “（1）”“（2）”（全角中文括号 + 阿拉伯数字）
表格编号：如 “表 3.1.1”“表 3.2.1”（“表”+ 章节编号 + 顺序号），表格列结构需与模板一致（如 “桥墩、构件、部位、缺陷类型、现场照片”），表格内空白处需填充示例数据（如 “HC-00”“0# 防落梁块”）或标注 “具体数据详见配套 Excel”。
图片编号：如 “HC-00 - 大里程侧右侧墩台破损.jpg”（桥墩编号 + 部位 + 缺陷类型 +.jpg），需与表格 “现场照片” 列一一对应。
10、必须严格遵循模板中的示例桥梁编号规则
桥梁编号格式：未提供时标注 “未提供，暂按‘厦门轨道交通 + 区段名称’分类”。
桥墩编号：示例为 HC-00、HC-01，输入未提供时沿用 “XX-00” 格式（XX 为区段简称）。
构件编号：示例为 “3# 梁”“0# 墩”“0# 垫石”，需沿桥梁前进方向逐墩编号，梁体从 1 开始，其余从 0 开始。
缺陷编号：示例为 “墩台破损”“防滑块顶死”，需与模板 “缺陷类型” 列表述一致。
要求：不得调整编号形式，不得创造新的编号体系，输入缺失编号时保持模板默认格式，不得推断填补。

------------------------------------------------------------
【模板插入与生成报告】
------------------------------------------------------------
11、将优化后的缺陷内容插入到模板对应位置，重点填充以下核心位置：
开头汇总表格：{project_name}（如 “厦门轨道交通桥梁支座检测项目”）、{defect_summary}（分梁体 / 支座系统两类概括缺陷，去重 + 标注每种缺陷数量，格式：缺陷 1（X 处）、缺陷 2（X 处））、{main_findings}（含检测区段范围、缺陷总数（需标注数据来源）、各优先级缺陷数量及类型分布）。
1.1 工程概况：{pier_info}（需列出所有检测区段名称，如 “后溪站 - 车辆段、起点 - 软三东等 13 个区段”，标注桥墩数量数据来源）。
2.1 总规则：{pier_naming_rule}（输入未提供时需写 “未提供，暂按模板默认规则：沿东向西里程方向，桥墩、构件编号从 0 开始”）。
3.1 梁体、桥墩、墩台：{excel_filtered_table}（需填充模板表 3.1.1，列结构不变，至少含 1 行示例数据，其余标注 “具体数据详见配套 Excel，按‘包含 #梁、# 墩’筛选后填充”）。
3.2 支座系统：{excel_filtered_table}（需填充模板表 3.2.1，列结构不变，至少含 1 行示例数据，其余标注 “具体数据详见配套 Excel，按‘包含 #防落梁块、# 垫石、# 支座板、# 支座’筛选后填充”）。
3.3 缺陷分析：
{defect_list}（按 “（1）XX 构件：缺陷 1（X 处）、缺陷 2（X 处）……；（2）XX 构件：缺陷 1（X 处）、缺陷 2（X 处）……” 格式，同行展示，每个缺陷后必须标注数量）；
{defect_causes}（含推测标注 + 关联缺陷数量，说明每种缺陷数量对应的可能成因，如 “墩台破损（4 处）可能由外力碰撞导致”）；
{suggestions}（按优先级分点，每个建议对应缺陷类型及数量，如 “高优先级：立即维修防滑块顶死（2 处）、螺栓松脱（1 处）”）。
附录：{appendix}（4 个子项需完整填充，{bridge_code} 未提供时标注 “未提供，暂按‘厦门轨道交通 + 区段名称’分类”，{id_file_mapping} 需写清照片命名格式及存储逻辑）。

12、模板占位符说明（需 100% 输出，不得省略）以下占位符将出现在 docx 报告模板中，请严格按字段输出对应内容，填充要求如下：
{bridge_name}：桥梁名称。若用户输入中提供则直接填充；未提供时填为 “厦门轨道交通各区间桥梁支座”。{bridge_code}：桥梁编号。若未提供，标注为 “未提供，暂按‘厦门轨道交通 + 区段名称’分类”。{main_findings}：检查总体结论，需包括检测区段范围、缺陷总数（需标注数据来源，如 “共发现缺陷 XX 处，数据来源于配套 Excel 统计”）、各优先级缺陷数量及类型分布。例如：“本次检测覆盖 XX 个区段，共发现缺陷 XX 处（数据来源于配套 Excel 统计），其中高优先级缺陷 XX 处（含螺栓松脱 2 处、防滑块顶死 3 处），需立即处置；中优先级缺陷 XX 处，需定期巡检；低优先级缺陷 XX 处，需定期清理”。{defect_list}：缺陷统计与说明。分为 “梁体、桥墩、墩台”“支座系统” 两大类，格式强制要求：
梁体、桥墩、墩台类：（1）墩台：缺陷 1（X 处）、缺陷 2（X 处）、……；（2）梁体：缺陷 1（X 处）、缺陷 2（X 处）、……；（3）桥墩：缺陷 1（X 处）、缺陷 2（X 处）、……（构件分类不得遗漏，按 “墩台→梁体→桥墩” 顺序）；
支座系统类：（1）防落梁块：缺陷 1（X 处）、缺陷 2（X 处）、……；（2）垫石：缺陷 1（X 处）、缺陷 2（X 处）、……；（3）支座板：缺陷 1（X 处）、缺陷 2（X 处）、……；（4）球形支座：缺陷 1（X 处）、缺陷 2（X 处）、……（构件分类不得遗漏，按 “防落梁块→垫石→支座板→球形支座” 顺序）；
每个缺陷名称后必须标注具体数量（格式：缺陷名称（X 处）），数量来源于输入统计数据的去重计数，无数据时标注 “缺陷名称（数量详见配套 Excel）”；
整条内容必须在同一行，不要换行；不允许使用 Markdown 格式、不允许出现 "-"、"*"、"加粗"；
缺陷需去重，相同缺陷名称合并并统计总数量（如 “墩台涂装漆脱落” 仅保留 1 个，标注总处数）。
{component_status}：构件状态分析。按以下构件依次说明完好 / 缺陷情况，每个构件需关联缺陷数量：“梁体（发现 XX 类缺陷，共 XX 处）”“桥墩（发现 XX 类缺陷，共 XX 处）”“墩台（发现 XX 类缺陷，共 XX 处）”“垫石（发现 XX 类缺陷，共 XX 处）”“防落梁块（发现 XX 类缺陷，共 XX 处）”“支座板（发现 XX 类缺陷，共 XX 处）”“球形支座（发现 XX 类缺陷，共 XX 处）”；完好构件标注 “XX 构件：未发现缺陷”。
{suggestions}：维修加固建议，按高、中、低优先级分项列出，每个建议需明确对应缺陷类型及数量，格式示例：
（1）高优先级：立即维修防滑块顶死（2 处）、螺栓松脱（1 处）、螺栓缺失（1 处），更换缺失螺栓，紧固松脱螺栓，调整防滑块间距至规范要求；
（2）中优先级：定期巡检并计划维修墩台破损（4 处）、垫石缺棱断角（5 处）、环氧砂浆层破损（2 处），修补破损区域，修复涂装漆脱落（3 处）区域；
（3）低优先级：定期清理施工垃圾残留（6 处），修复小破损的防尘围挡（4 处）。
{appendix}：附录内容。需完整填充模板要求的 4 个子项；如遇数据缺失按默认规则填写，例如 “编号规则拆解：桥墩标识暂用 HC-XX 格式……”。
{project_name}：工程名称。用户输入中提供则直接填充。
{inspection_result}：检查结果，需概括并去重，每个缺陷后标注数量，分为：
“梁体、桥墩、墩台”：墩台：墩台破损（4 处）、墩台表面涂装漆脱落（1 处）……；梁体：梁体麻面（2 处）、梁体破损（1 处）……；桥墩：无明显缺陷；
“支座系统”：防落梁块：防滑块顶死（2 处）、螺栓锈蚀（14 处）……；垫石：垫石缺棱断角（5 处）、垫石破损（1 处）……；支座板：上支座板螺栓锈蚀（3 处）……；球形支座：防尘围挡翻起（3 处）……。
{defect_summary}：缺陷情况概括，与 {inspection_result} 内容完全一致，用于填入开头汇总表格 “检查结果” 列，需严格保留缺陷 + 数量的标注格式。
{pier_info}：桥墩位置与数量说明。需列出全部检测区段，并标注数据来源，如 “桥墩数量详见配套 Excel 统计 Sheet”。
{pier_naming_rule}：桥墩编号命名规则。若未提供，则写 “未提供，暂按模板默认：东向西里程方向，编号从 0 开始，如‘0# 墩’”。
{excel_filtered_table}：Excel 筛选结果表格内容。填入模板表 3.1.1、表 3.2.1，包括示例数据和数据来源说明，如：“HC-00、0# 墩、大里程侧右侧、墩台破损、HC-00-xxx.jpg”。
{defect_causes}：缺陷情况与成因总结，需关联缺陷数量，格式示例：
基于桥梁养护常规经验的推测（如环境腐蚀、运营损耗、施工残留等），非本次检测统计结论，最终成因需以补充数据为准。其中：墩台破损（4 处）可能由外力碰撞、施工操作不当或长期使用磨损造成；墩台表面涂装漆脱落（1 处）可能受环境风化、紫外线照射影响；梁体麻面（2 处）可能因施工时混凝土振捣不密实导致；防落梁块螺栓锈蚀（14 处）主要由环境腐蚀引起；垫石缺棱断角（5 处）多由长期荷载、温度变化及施工精度不足造成。
若输入提供成因，则基于输入汇总 + 关联数量；若无输入，则写推测性成因 + 关联数量，并标注 “非统计结论”。
{defect_distribution_and_solutions}：缺陷分布及对应建议。包括缺陷集中区段、类型（含数量）、以及对应处置措施，示例：“高优先级缺陷主要集中在防落梁块（螺栓松脱 1 处、螺栓缺失 1 处、防滑块顶死 2 处），需立即处置；中优先级缺陷分布在墩台（破损 4 处）、垫石（缺棱断角 5 处）、环氧砂浆层（破损 2 处）等混凝土结构，需定期维修；低优先级缺陷分布在施工垃圾残留（6 处）、防尘围挡小破损（4 处）等部位，需定期清理维护”。
{id_file_mapping}：编号与图片文件的对应方式。需说明照片命名格式与存储逻辑，如 “照片命名为‘桥墩 - 部位 - 缺陷类型.jpg’，按‘区段 - 桥墩’文件夹存储”。
要求：所有字段必须输出，不得省略；输出内容必须能够直接用于 docx 占位符替换；不得创造新的占位符；无输入数据时需标注明确的替代说明（如 “缺陷名称（数量详见配套 Excel）”），不得空白；数量统计必须基于输入统计数据的去重计数，不得虚构数量；相同缺陷名称需合并统计总处数，不得重复标注。
【最终输出要求】
13、最终输出为一份完整的桥梁检测报告正文（将用于生成 docx）
内容完整：包含开头汇总表格、目录、1-3 章节、附录，无任何模块缺失；
符合模板结构：章节顺序、标题层级、表格格式与模板完全一致；
所有提示项已替换为正式文本：无 “（* …… ）” 残留；
所有缺陷描述已规范化：使用行业术语，格式统一；
编号完全符合模板规则：章节、表格、图片、构件编号格式正确。

14.其他要求
不输出推理过程，不输出模型相关信息，不新增非模板章节；
目录页码标注需与章节实际位置匹配（如 “1 概况 1”“2 部位与缺陷命名规则 2”）；
附录所有子项需分段呈现，不得合并或省略。

请等待输入原始统计文本与模板内容。

"""
# ============================================================
# 读取统计报告和模板
# ============================================================
raw_report_text = read_text_auto(os.environ.get("RAW_REPORT_PATH"))
template_text = read_text_auto(os.environ.get("TEMPLATE_REPORT_PATH"))


# ============================================================
# 调用模型（流式）
# ============================================================
stream = client.chat.completions.create(
    model=os.environ.get("MODEL_NAME"),
    messages=[
        {"role": "system", "content": prompt_system},
        {
            "role": "user",
            "content": (
                "请根据以下数据，生成完整的桥梁支座检测报告：\n\n"
                "【统计报告】\n"
                f"{raw_report_text}\n\n"
                "【报告模板】\n"
                f"{template_text}"
            )
        }
    ],
    stream=True,
    reasoning_effort="medium"
)

reasoning_content = ""
content = ""

print("📡 模型生成中...\n")

with stream:
    for chunk in stream:
        delta = chunk.choices[0].delta

        if getattr(delta, "reasoning_content", None):
            reasoning_content += delta.reasoning_content
            print(delta.reasoning_content, end="")

        if delta.content is not None:
            content += delta.content
            print(delta.content, end="")


# ============================================================
# 生成 docx 报告
# ============================================================
output_docx_path = "F:/桥梁支座检测报告_4.docx"
doc = Document()

# 按段落写入内容，统一设置Body Text样式
final_report = content  # 使用与用户代码一致的变量名
for para_text in final_report.split("\n"):
    para = doc.add_paragraph(para_text)
    para.style = "Body Text"   # 统一正文样式

# 预留：如需自动插入某些表格
# 示例:
# defect_table = [["序号", "缺陷名称", "位置"], ["1", "裂缝", "HC-00"]]
# insert_generated_table(doc, defect_table)

doc.save(output_docx_path)

print(f"\n\n🎉 报告生成完成：{output_docx_path}")
